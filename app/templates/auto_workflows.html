{% extends "base.html" %}

{% block title %}
Auto Workflows
{% endblock %}

{% block content %}
    <div class="container">
        <h1 class="mb-4">Auto Workflows</h1>

        <!-- Navigation Tabs -->
        <ul class="nav nav-tabs mt-4" id="workflowTabs" role="tablist">
            <li class="nav-item">
                <a class="nav-link active" id="files-overview-tab" data-toggle="tab" href="#files-overview" role="tab" aria-controls="files-overview" aria-selected="true">Files Overview</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="dom-purchase-tab" data-toggle="tab" href="#dom-purchase" role="tab" aria-controls="dom-purchase" aria-selected="false">Dom Purchase Invoices</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="dom-sales-tab" data-toggle="tab" href="#dom-sales" role="tab" aria-controls="dom-sales" aria-selected="false">Dom Sales Invoices</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="inventory-tab" data-toggle="tab" href="#inventory" role="tab" aria-controls="inventory" aria-selected="false">Inventory</a>
            </li>
        </ul>



           <!-- Tab Content -->
        <div class="tab-content mt-5" id="workflowTabContent">

            <!-- Update Invoice Records Button -->
            <button id="update-invoice-record-btn" class="btn btn-warning mb-3">
                Update Invoice Records
            </button>


            <!-- Files Overview Tab -->
            <div class="tab-pane fade show active" id="files-overview" role="tabpanel" aria-labelledby="files-overview-tab">
                <div class="overview-section">
                    <h2>Files Overview</h2>

                    <!-- Cards Row -->
                    <div class="row">

                        <!-- Purchase Invoices Card -->
                        <div class="col-md-4">
                            <div class="card text-center mb-4">
                                <div class="card-body">
                                    <i id="purchase-invoices-icon" class="fas fa-file-invoice-dollar fa-2x mb-3"></i>
                                    <h5 class="card-title">Purchase Invoices</h5>
                                    <p class="lead"><span id="purchase-invoices-count" class="file-count">0</span> files</p>
                                    <button class="btn btn-primary" onclick="toggleList('purchase-tenants-list')">View Details</button>
                                    <ul id="purchase-tenants-list" class="tenant-list mt-3"></ul>
                                </div>
                            </div>
                        </div>

                        <!-- Sales Invoices Card -->
                        <div class="col-md-4">
                            <div class="card text-center mb-4">
                                <div class="card-body">
                                    <i id="sales-invoices-icon" class="fas fa-file-invoice fa-2x mb-3"></i>
                                    <h5 class="card-title">Sales Invoices</h5>
                                    <p class="lead"><span id="sales-invoices-count" class="file-count">0</span> files</p>
                                    <button class="btn btn-primary" onclick="toggleList('sales-tenants-list')">View Details</button>
                                    <ul id="sales-tenants-list" class="tenant-list mt-3"></ul>
                                </div>
                            </div>
                        </div>

                        <!-- Inventory Card -->
                        <div class="col-md-4">
                            <div class="card text-center mb-4">
                                <div class="card-body">
                                    <i id="inventory-icon" class="fas fa-box-open fa-2x mb-3"></i>
                                    <h5 class="card-title">Inventory</h5>
                                    <p class="lead"><span id="inventory-count" class="file-count">0</span> journals</p>
                                    <button class="btn btn-primary" onclick="toggleList('inventory-tenants-list')">View Details</button>
                                    <ul id="inventory-tenants-list" class="tenant-list mt-3"></ul>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>

          
            <!-- Process Dom Purchase Invoices Tab -->
            <div class="tab-pane fade" id="dom-purchase" role="tabpanel" aria-labelledby="dom-purchase-tab">
                <div class="purchase-invoice-section container mt-4">

                    
                    <!-- Pre-Processing Section -->
                    <div class="card mb-4 shadow-sm">
                        <div class="card-header text-white" style="background-color: rgba(128, 128, 128, 1.0);">
                            <h4 class="mb-0">Pre-Processing Section</h4>
                        </div>
                        <div class="card-body">
                            <button id="pre-process-btn" class="btn btn-primary mb-3" onclick="preProcessDomPurchaseInvoices()">
                                Pre-Process Dom Purchase Invoices
                            </button>
                            <h5 class="mt-4">Weekly Matched Files Summary</h5>
                            <button id="update-weekly-matched-files" class="btn btn-info mb-3" onclick="fetchWeeklyMatchedFilesSummary()">Update</button>
                            <div class="table-responsive">
                                <table id="weekly-matched-files-table" class="table table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Week</th>
                                            <th>Matched Files</th>
                                            <th>Expected Files</th>
                                            <th>Missing Stores</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Data dynamically inserted here -->
                                    </tbody>
                                </table>
                            </div>
                            <div id="pre-process-progress-container" class="progress mt-3" style="display:none;">
                                <div id="pre-process-progress-bar" class="progress-bar progress-bar-striped" style="width: 0%;"></div>
                            </div>
                            <p id="pre-process-progress-text" class="mt-2">0% Complete</p>
                            <p id="pre-process-task-status" class="mt-3 text-muted"></p>
                            
                            <!-- Pre-Process Task Errors -->
                            <div id="pre-process-task-errors" class="alert alert-danger mt-3" style="display: none;">
                                <h5>Task Errors:</h5>
                                <ul id="pre-process-error-list" class="mb-0">
                                    <!-- Error messages dynamically added here -->
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Processing Section -->
                    <div class="card mb-4 shadow-sm">
                        <div class="card-header text-white" style="background-color: rgba(128, 128, 128, 1.0);">
                            <h4 class="mb-0">Processing Section</h4>
                        </div>
                        <div class="card-body">
                            <button id="process-btn" class="btn btn-primary mb-3" onclick="processDomPurchaseInvoices()">
                                Process Dom Purchase Invoices
                            </button>
                            <label for="week-selector">Select Week:</label>
                                <select id="week-selector" class="form-select">
                                    <option selected disabled>Select a week</option>
                                </select>
                            <div id="process-progress-container" class="progress mt-3" style="display:none;">
                                <div id="process-progress-bar" class="progress-bar progress-bar-striped" style="width: 0%;"></div>
                            </div>
                            <p id="process-progress-text" class="mt-2">0% Complete</p>
                            <p id="process-task-status" class="mt-3 text-muted"></p>
                            
                            <!-- Process Task Errors -->
                            <div id="process-task-errors" class="alert alert-danger mt-3" style="display: none;">
                                <h5>Task Errors:</h5>
                                <ul id="process-error-list" class="mb-0">
                                    <!-- Error messages dynamically added here -->
                                </ul>
                            </div>
                                
                        </div>
                    </div>

                    <!-- Invoice Record Summary Section -->
                    <div class="card mb-4 shadow-sm">
                        <div class="card-header text-white" style="background-color: rgba(128, 128, 128, 1.0);">
                            <h4 class="mb-0">Invoice Record Summary</h4>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="week-selector-summary" class="form-label">Select Week:</label>
                                    <select id="week-selector-summary" class="form-select">
                                        <option value="" disabled selected>Select Week</option>
                                        <script>
                                            for (let i = 1; i <= 52; i++) {
                                                document.write(`<option value="${i}">Week ${i}</option>`);
                                            }
                                        </script>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="year-selector-summary" class="form-label">Select Year:</label>
                                    <select id="year-selector-summary" class="form-select">
                                        <option value="" disabled selected>Select Year</option>
                                        <script>
                                            const currentYear = new Date().getFullYear();
                                            for (let y = currentYear - 5; y <= currentYear; y++) {
                                                document.write(`<option value="${y}">${y}</option>`);
                                            }
                                        </script>
                                    </select>
                                </div>
                            </div>
                            <button class="btn btn-primary mb-3" onclick="loadInvoiceRecordSummary()">Load Summary</button>
                            <div class="table-responsive">
                                <table id="invoice-record-summary-table" class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Store Name</th>
                                            <th>Store Number</th>
                                            <th>Tenant Name</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Data dynamically inserted here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Invoices Created Section -->
                    <div class="card shadow-sm">
                        <div class="card-header text-white" style="background-color: rgba(128, 128, 128, 1.0);">
                            <h4 class="mb-0">Invoices Created</h4>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table id="dom-purchase-invoices-table" class="table table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Tenant Name</th>
                                            <th>CSV Filename</th>
                                            <th>PDF Filename</th>
                                            <th>Total Invoice</th>
                                            <th>Statement Date</th>
                                            <th>Store Code</th>
                                            <th>Timestamp</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Data dynamically inserted here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>



            


            

            <!-- Process Dom Sales Invoices Tab -->
            <div class="tab-pane fade" id="dom-sales" role="tabpanel" aria-labelledby="dom-sales-tab">
                <div class="sales-invoice-section container mt-4">

                    <!-- Processing Section -->
                    <div class="card mb-4 shadow-sm">
                        <div class="card-header bg-secondary text-white">
                            <h4 class="mb-0">Processing Section</h4>
                        </div>
                        <div class="card-body">
                            <button id="process-sales-btn" class="btn btn-primary mb-3" onclick="processDomSalesInvoices()">
                                Process Dom Sales Invoices
                            </button>
                            <div id="sales-progress-container" class="progress mt-3" style="display:none;">
                                <div id="sales-progress-bar" class="progress-bar progress-bar-striped" style="width: 0%;"></div>
                            </div>
                            <p id="sales-progress-text" class="mt-2">0% Complete</p>
                            <p id="sales-task-status" class="mt-3 text-muted"></p>
                    
                            <!-- Process Task Errors -->
                            <div id="sales-task-errors" class="alert alert-danger mt-3" style="display: none;">
                                <h5>Task Errors:</h5>
                                <ul id="sales-error-list" class="mb-0"></ul>
                            </div>
                        </div>
                    </div>


                    <!-- Invoice Record Summary Section -->
                    <div class="card shadow-sm">
                        <div class="card-header bg-secondary text-white">
                            <h4 class="mb-0">Invoice Record Summary</h4>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="week-selector-sales" class="form-label">Select Week:</label>
                                    <select id="week-selector-sales" class="form-select">
                                        <option value="" disabled selected>Select Week</option>
                                        <script>
                                            for (let i = 1; i <= 52; i++) {
                                                document.write(`<option value="${i}">Week ${i}</option>`);
                                            }
                                        </script>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="year-selector-sales" class="form-label">Select Year:</label>
                                    <select id="year-selector-sales" class="form-select">
                                        <option value="" disabled selected>Select Year</option>
                                        <script>
                                            const currentYear2 = new Date().getFullYear();
                                            for (let y = currentYear2 - 5; y <= currentYear2; y++) {
                                                document.write(`<option value="${y}">${y}</option>`);
                                            }
                                        </script>
                                    </select>
                                </div>
                            </div>
                            <button class="btn btn-primary mb-3" onclick="loadSalesInvoiceRecordSummary()">Load Summary</button>
                            <div class="table-responsive">
                                <table id="sales-invoice-record-summary-table" class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Store Name</th>
                                            <th>Store Number</th>
                                            <th>Tenant Name</th>
                                            <th>Status for Mileage</th>
                                            <th>Status for Sales</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Data dynamically inserted here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Invoices Created Section -->
                    <div class="card mt-4 shadow-sm">
                        <div class="card-header bg-secondary text-white">
                            <h4 class="mb-0">Invoices Created</h4>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table id="dom-sales-invoices-table" class="table table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Tenant Name</th>
                                            <th>File Name</th>
                                            <th>Supplier Name</th>
                                            <th>Start Date</th>
                                            <th>End Date</th>
                                            <th>Timestamp</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Rows will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>



            <!-- Inventory Processing -->
            <div class="tab-pane fade" id="inventory" role="tabpanel" aria-labelledby="inventory-tab">
                <div class="inventory-section container mt-4">
                    <h2>Inventory Section</h2>

                    <div class="card mb-4 shadow-sm">
                        <div class="card-header bg-info text-white">
                            <h4 class="mb-0">Create Inventory Template</h4>
                        </div>
                        <div class="card-body text-center">
                            <button id="create-template-btn" class="btn btn-primary" onclick="downloadInventoryTemplate()">Create and Download</button>
                        </div>
                    </div>
            
                    <!-- Processing Section -->
                    <div class="card mb-4 shadow-sm">
                        <div class="card-header bg-info text-white">
                            <h4 class="mb-0">Processing Section</h4>
                        </div>
                        <div class="card-body">
                            <button id="process-inventory-btn" class="btn btn-primary mb-3" onclick="processInventoryData()">
                                Process Inventory Data
                            </button>
                            <div id="inventory-progress-container" class="progress mt-3" style="display:none;">
                                <div id="inventory-progress-bar" class="progress-bar progress-bar-striped" style="width: 0%;"></div>
                            </div>
                            <p id="inventory-progress-text" class="mt-2">0% Complete</p>
                            <p id="inventory-task-status" class="mt-3 text-muted"></p>
                            
                            <!-- Process Task Errors -->
                            <div id="inventory-task-errors" class="alert alert-danger mt-3" style="display: none;">
                                <h5>Task Errors:</h5>
                                <ul id="inventory-error-list" class="mb-0"></ul>
                            </div>
                        </div>
                    </div>

                     <!-- Inventory Status Table -->
                    <div class="card mb-4 shadow-sm">
                        <div class="card-header bg-info text-white">
                            <h4 class="mb-0">Inventory Status</h4>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table id="inventory-status-table" class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Month</th>
                                            <th>Year</th>
                                            <th>Data Complete</th>
                                            <th>Processed</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Data dynamically inserted here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
            
        </div>
    </div>

    <style>
        
        /* Default icon and file count colors */
        .red-icon, .file-count.red {
            color: red;
        }

        .green-icon, .file-count.green {
            color: green;
        }

        /* Card styling */
        .card {
            border-radius: 10px;
            border: none;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .card-title {
            font-weight: bold;
            color: #333;
        }

        .file-count {
            font-size: 24px;
            font-weight: bold;
        }


        .tenant-list {
            display: none;
            list-style-type: none; /* This removes the bullet points */
            padding-left: 0; /* This removes the default padding */
            margin: 0; /* Adjusts the margin to align the list better with other content */
        }

        .tenant-list li {
            padding: 8px 0; /* Adds padding to each list item for better spacing */
            border-bottom: 1px solid #ccc; /* Optional: adds a subtle line between items */
            font-size: 10px; /* Adjust the font size as needed */
            line-height: 1.5; /* Improves line spacing */
        }

        .tenant-list.visible {
            display: block;
        }

        .btn-progress {
            position: relative;
            overflow: hidden;
            color: white;
            border: 2px solid transparent; /* Initially no border */
            border-radius: 5px;
            transition: all 0.3s ease;
        }

        .btn-progress::before {
            content: "";
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            background-color: #28a745; /* Green color for progress */
            width: 0%; /* Start with no progress */
            transition: width 0.3s ease;
            z-index: -1; /* Ensure the progress bar is behind the text */
        }

        .btn-progress.processing {
            background-color: #28a745;
            border: 2px solid #28a745; /* Add a green border during processing */
        }

        .btn-progress.complete {
            border-color: #28a745; /* Keep the green border when complete */
        }

        .btn-progress.complete::before {
            width: 100%;
        }



    </style>

    <script>


        function checkActiveTask() {
            fetch('/auto_workflows/active_task_status')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'no_active_task') {
                        enableButtons(['pre-process-btn', 'process-btn', 'process-sales-btn', 'process-inventory-btn']);
                        document.getElementById('pre-process-task-status').textContent = 'Ready to process';
                        document.getElementById('process-task-status').textContent = 'Ready to process';
                        document.getElementById('sales-task-status').textContent = 'Ready to process';
                        document.getElementById('inventory-task-status').textContent = 'Ready to process';
                        return;
                    }

                    let taskType = data.task_type;
                    let taskId = data.task_id;

                    // Disable buttons and track task progress
                    if (taskType === 'pre_process_dom_purchase_invoices' || taskType === 'process_dom_purchase') {
                        disableButtons(['pre-process-btn', 'process-btn']);
                        trackTaskProgress(taskId, taskType.includes('pre_process') ? 'pre-process' : 'process');
                    } else if (taskType === 'pre_process_dom_sales_invoices' || taskType === 'process_dom_sales') {
                        disableButtons(['process-sales-btn']);
                        trackTaskProgress(taskId, 'sales');
                    } else if (taskType === 'process_inventory') {
                        disableButtons(['process-inventory-btn']);
                        trackTaskProgress(taskId, 'inventory');
                    }
                })
                .catch(error => console.error('Error checking active task:', error));
        }


        function disableButtons(buttonIds) {
            buttonIds.forEach(id => {
                const button = document.getElementById(id);
                if (button) button.disabled = true;
            });
        }

        function enableButtons(buttonIds) {
            buttonIds.forEach(id => {
                const button = document.getElementById(id);
                if (button) button.disabled = false;
            });
        }


        // Disable specific workflow buttons
        function disablePurcahseInvoiceButtons() {
            // Select the Pre-Process Dom Purchase Invoices button and disable it
            const preProcessButton = document.getElementById('pre-process-btn');
            if (preProcessButton) {
                preProcessButton.disabled = true;
            }

            // Select the Process Dom Purchase Invoices button and disable it
            const processButton = document.getElementById('process-btn');
            if (processButton) {
                processButton.disabled = true;
            }
        }

        // enable specific workflow buttons
        function enablePurcahseInvoiceButtons() {
            // Select the Pre-Process Dom Purchase Invoices button and disable it
            const preProcessButton = document.getElementById('pre-process-btn');
            if (preProcessButton) {
                preProcessButton.disabled = false;
            }

            // Select the Process Dom Purchase Invoices button and disable it
            const processButton = document.getElementById('process-btn');
            if (processButton) {
                processButton.disabled = false;
            }
        }


        function toggleList(listId) {
            const tenantList = document.getElementById(listId);
            const button = document.querySelector(`button[onclick="toggleList('${listId}')"]`); // Select the button that toggles this list
            
            if (tenantList.classList.contains('visible')) {
                tenantList.classList.remove('visible'); // Hide the list
                button.textContent = 'View Details'; // Change button text to "View Details"
            } else {
                tenantList.classList.add('visible'); // Show the list
                button.textContent = 'Hide Details'; // Change button text to "Hide Details"
            }
        }

        function fetchWeeklyMatchedFilesSummary() {
            fetch('/auto_workflows/check_pre_processed_invoices')
                .then(response => response.json())
                .then(data => {
                    const tableBody = document.getElementById('weekly-matched-files-table').getElementsByTagName('tbody')[0];
                    tableBody.innerHTML = '';  // Clear the table

                    const weekSelector = document.getElementById('week-selector');
                    weekSelector.innerHTML = '<option selected disabled>Select a week</option>';  // Reset the dropdown

                    // Loop through the weeks summary and create table rows
                    for (const [week, details] of Object.entries(data.weeks_summary)) {
                        const row = `<tr>
                            <td>${week}</td>
                            <td>${details.matched_invoice_count}</td>
                            <td>${details.expected_invoice_count}</td>
                            <td>${details.missing_store_numbers.join(', ') || 'None'}</td>
                        </tr>`;
                        tableBody.innerHTML += row;

                        // Add each week to the dropdown
                        const option = document.createElement('option');
                        option.value = week;
                        option.text = `Week ${week}`;
                        weekSelector.appendChild(option);
                    }
                })
                .catch(error => console.error('Error fetching weekly matched files summary:', error));
        }


        



        function fetchFileOverviewData() {
            fetch('/auto_workflows/data')
                .then(response => response.json())
                .then(data => {
                    console.log('Data fetched for file overview:', data);

                    // Set file counts and color indicators
                    setFileCountAndColor('purchase-invoices-count', 'purchase-invoices-icon', data.purchase_invoices_count);
                    setFileCountAndColor('sales-invoices-count', 'sales-invoices-icon', data.sales_invoices_count);
                    setFileCountAndColor('inventory-count', 'inventory-icon', data.inventory_journals_count);
                    

                    // Populate tenant lists
                    populateTenantList('purchase-tenants-list', data.purchase_invoices_tenants);
                    populateTenantList('sales-tenants-list', data.sales_invoices_tenants);
                    populateTenantList('inventory-tenants-list', data.inventory_tenants);
         
                })
                .catch(error => console.error('Error fetching file overview data:', error));
        }


        function setFileCountAndColor(elementId, iconId, count) {
            const element = document.getElementById(elementId);
            const icon = document.getElementById(iconId);

            if (!element || !icon) {
                console.error(`Element or icon not found: ${elementId}, ${iconId}`);
                return; // Exit the function if elements are not found
            }

            element.textContent = count;
            if (count > 0) {
                element.classList.remove('green');
                element.classList.add('red');
                icon.classList.remove('green-icon');
                icon.classList.add('red-icon');
            } else {
                element.classList.remove('red');
                element.classList.add('green');
                icon.classList.remove('red-icon');
                icon.classList.add('green-icon');
            }
        }



        function populateTenantList(listId, tenants) {
            console.log(`Populating tenant list: ${listId} with data:`, tenants);
            const list = document.getElementById(listId);
            if (!list) {
                console.error(`Tenant list element with id ${listId} not found.`);
                return;
            }

            if (tenants && tenants.length > 0) {
                list.innerHTML = tenants.map(tenant => `<li>${tenant.name} (${tenant.file_count} files)</li>`).join('');
                console.log(`Tenant list ${listId} populated with ${tenants.length} tenants.`);
            } else {
                list.innerHTML = '<li>No files to process</li>';
                console.log(`Tenant list ${listId} has no tenants.`);
            }
        }



        // Fetch Dom Purchase Invoice logs
        function fetchDomPurchaseInvoiceLogs() {
            fetch('/get_dom_purchase_invoice_logs')
                .then(response => response.json())
                .then(data => {
                    const tableBody = document.getElementById('dom-purchase-invoices-table').getElementsByTagName('tbody')[0];
                    tableBody.innerHTML = '';  // Clear the table

                    // Loop through the log data and create table rows
                    data.forEach(log => {
                        const row = `<tr>
                            <td>${log.tenant_name}</td>
                            <td>${log.csv_filename}</td>
                            <td>${log.pdf_filename}</td>
                            <td>${log.total_invoice}</td>
                            <td>${log.statement_date}</td>
                            <td>${log.store_code}</td>
                            <td>${log.timestamp}</td>
                        </tr>`;
                        tableBody.innerHTML += row;
                    });

                    // Reinitialize DataTable (if it's already initialized)
                    if ($.fn.dataTable.isDataTable('#dom-purchase-invoices-table')) {
                        $('#dom-purchase-invoices-table').DataTable().destroy();
                    }

                    // Initialize DataTable
                    $('#dom-purchase-invoices-table').DataTable();
                })
                .catch(error => console.error('Error fetching Dom Purchase invoice logs:', error));
        }


        // Fetch Dom Sales Invoice logs
        function fetchDomSalesInvoiceLogs() {
            fetch('/get_dom_sales_invoice_logs')
                .then(response => response.json())
                .then(data => {
                    const tableBody = document.getElementById('dom-sales-invoices-table').getElementsByTagName('tbody')[0];
                    tableBody.innerHTML = '';  // Clear the table

                    data.forEach(log => {
                        const row = `<tr>
                            <td>${log.tenant_name}</td>
                            <td>${log.file_name}</td>
                            <td>${log.supplier_name}</td>
                            <td>${log.start_date}</td>
                            <td>${log.end_date}</td>
                            <td>${log.timestamp}</td>
                        </tr>`;
                        tableBody.innerHTML += row;
                    });

                    if ($.fn.dataTable.isDataTable('#dom-sales-invoices-table')) {
                        $('#dom-sales-invoices-table').DataTable().destroy();
                    }
                    $('#dom-sales-invoices-table').DataTable();
                })
                .catch(error => console.error('Error fetching Dom Sales invoice logs:', error));
        }


        window.onload = function() {
            fetchFileOverviewData();
            fetchDomPurchaseInvoiceLogs();
            fetchDomSalesInvoiceLogs();
            checkActiveTask();
            loadInventoryStatus();
        };

        setInterval(function() {
            fetchFileOverviewData();
            fetchDomPurchaseInvoiceLogs();
            fetchDomSalesInvoiceLogs();
        }, 300000); // Refresh every 5 minutes

        

        function preProcessDomPurchaseInvoices() {
            // Disable the button and show the progress bar
            disablePurcahseInvoiceButtons()
            document.getElementById('pre-process-task-status').textContent = "Task is running...";
            document.getElementById('pre-process-progress-container').style.display = "block";
            
            // Clear any previous errors
            const errorContainer = document.getElementById('pre-process-task-errors');
            const errorList = document.getElementById('pre-process-error-list');
            errorContainer.style.display = 'none';
            errorList.innerHTML = '';
        
            // Send request to start Celery task
            fetch('/auto_workflows/pre_process_dom_purchase_invoices')
                .then(response => response.json())
                .then(data => {
                    if (data.task_id) {
                        trackTaskProgress(data.task_id, 'pre-process');
                    } else {
                        console.error('Error starting task:', data);
                        alert('Failed to start processing invoices.');
                        enablePurcahseInvoiceButtons()
                        document.getElementById('pre-process-task-status').textContent = "Error starting task.";
                    }
                })
                .catch(error => {
                    console.error('Error starting task:', error);
                    alert('Failed to start processing invoices.');
                    enablePurcahseInvoiceButtons()
                    document.getElementById('pre-process-task-status').textContent = "Error starting task.";
                });
        }

        function processDomPurchaseInvoices() {
            const selectedWeek = document.getElementById('week-selector').value;

            if (!selectedWeek) {
                alert("Please select a week before processing.");
                return;
            }

            disablePurcahseInvoiceButtons()
            document.getElementById('process-task-status').textContent = "Task is running...";
            document.getElementById('process-progress-container').style.display = "block";

             // Clear any previous errors
            const errorContainer = document.getElementById('process-task-errors');
            const errorList = document.getElementById('process-error-list');
            errorContainer.style.display = 'none';
            errorList.innerHTML = '';


            fetch(`/auto_workflows/process_dom_purchase_invoices?week=${selectedWeek}`)
                .then(response => response.json())
                .then(data => {
                    if (data.task_id) {
                        startTask(data.task_id, 'process');
                    } else {
                        console.error('Error starting task:', data);
                        alert('Failed to start processing invoices.');
                        enablePurcahseInvoiceButtons()
                        document.getElementById('process-task-status').textContent = "Error starting task.";
                    }
                })
                .catch(error => {
                    console.error('Error starting task:', error);
                    alert('Failed to start processing invoices.');
                    enablePurcahseInvoiceButtons()
                    document.getElementById('process-task-status').textContent = "Error starting task.";
                });
        }

        function processDomSalesInvoices() {
            disableButtons(['process-sales-btn']);
            document.getElementById('sales-task-status').textContent = "Task is running...";
            document.getElementById('sales-progress-container').style.display = "block";

            const errorContainer = document.getElementById('sales-task-errors');
            const errorList = document.getElementById('sales-error-list');
            errorContainer.style.display = 'none';
            errorList.innerHTML = '';

            fetch('/auto_workflows/process_dom_sales_invoices')
                .then(response => response.json())
                .then(data => {
                    if (data.task_id) {
                        trackTaskProgress(data.task_id, 'sales');
                    } else {
                        enableButtons(['process-sales-btn']);
                        document.getElementById('sales-task-status').textContent = "Error starting task.";
                    }
                })
                .catch(error => {
                    console.error('Error starting task:', error);
                    enableButtons(['process-sales-btn']);
                    document.getElementById('sales-task-status').textContent = "Error starting task.";
                });
        }



        function startTask(taskID, taskType) {
            function checkTaskStatus() {
                fetch('/auto_workflows/task_status/' + taskID)
                    .then(response => response.json())
                    .then(data => {
                        const progressBar = document.getElementById(`${taskType}-progress-bar`);
                        const progressText = document.getElementById(`${taskType}-progress-text`);
                        const taskStatus = document.getElementById(`${taskType}-task-status`);
                        const taskButton = document.getElementById(`${taskType}-btn`);

                        if (!progressBar || !progressText || !taskStatus || !taskButton) {
                            console.error(`Elements for task type '${taskType}' not found.`);
                            return;
                        }

                        var progress = data.progress || 0;
                        progressBar.style.width = progress + '%';
                        progressText.innerHTML = `${progress}% Complete`;

                        if (progress < 100) {
                            setTimeout(checkTaskStatus, 2000); // Poll every 2 seconds
                        } else {
                            taskButton.disabled = false; // Re-enable the button
                            taskStatus.innerHTML = data.state === 'SUCCESS' ? "Task completed!" : "Task failed.";
                        }
                    })
                    .catch(error => {
                        console.error('Error checking task status:', error);
                        const taskStatus = document.getElementById(`${taskType}-task-status`);
                        const taskButton = document.getElementById(`${taskType}-btn`);

                        if (taskStatus) {
                            taskStatus.innerHTML = "Error checking task status.";
                        }
                        if (taskButton) {
                            taskButton.disabled = false; // Re-enable the button on error
                        }
                    });
            }

            checkTaskStatus(); // Start polling the task status
        }



        function processInvoice(taskType) {
            const button = document.getElementById(`${taskType}-btn`);
            button.disabled = true;
            button.classList.remove('btn-primary');
            button.classList.add('btn-progress', 'processing');
            button.textContent = '0% Complete';

            // Send request to start the Celery task based on the taskType
            fetch(`/auto_workflows/process_${taskType}_invoices`, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.task_id) {
                        trackTaskProgress(data.task_id, {taskType});
                    } else {
                        button.textContent = 'Error starting task';
                        button.disabled = false;
                    }
                })
                .catch(error => {
                    console.error('Error starting task:', error);
                    button.textContent = 'Error starting task';
                    button.disabled = false;
                });
        }

        function trackTaskProgress(taskID, taskType) {
            const progressContainer = document.getElementById(`${taskType}-progress-container`);
            const progressBar = document.getElementById(`${taskType}-progress-bar`);
            const progressText = document.getElementById(`${taskType}-progress-text`);
            const taskStatus = document.getElementById(`${taskType}-task-status`);
            const errorContainer = document.getElementById(`${taskType}-task-errors`);
            const errorList = document.getElementById(`${taskType}-error-list`);

            function checkTaskStatus() {
                fetch(`/auto_workflows/task_status/${taskID}`)
                    .then(response => response.json())
                    .then(data => {
                        const progress = data.progress || 0;
                        progressBar.style.width = `${progress}%`;
                        progressText.textContent = `${progress}% Complete`;

                        if (data.message) {
                            taskStatus.textContent = data.message;
                        }

                        if (data.state === 'SUCCESS' || data.state === 'FAILURE') {
                            enablePurcahseInvoiceButtons();
                            enableButtons(['process-sales-btn']);
                            enableButtons(['process-inventory-btn']);
                            if (data.errors && data.errors.length > 0) {
                                errorList.innerHTML = '';
                                data.errors.forEach(error => {
                                    const errorItem = document.createElement('li');
                                    errorItem.textContent = error;
                                    errorList.appendChild(errorItem);
                                });
                                errorContainer.style.display = 'block';
                            }
                        } else {
                            setTimeout(checkTaskStatus, 2000);
                        }
                    })
                    .catch(error => {
                        console.error('Error checking task status:', error);
                        taskStatus.textContent = "Error checking task status.";
                    });
            }

            checkTaskStatus();
        }



        function displayErrors(errors) {
            const errorContainer = document.getElementById('task-errors');
            const errorList = document.getElementById('error-list');
            errorList.innerHTML = ''; // Clear previous errors

            if (errors && errors.length > 0) {
                errors.forEach(error => {
                    const errorItem = document.createElement('li');
                    errorItem.textContent = error;
                    errorList.appendChild(errorItem);
                });
                errorContainer.style.display = 'block'; // Show errors
            } else {
                errorContainer.style.display = 'none'; // Hide if no errors
            }
        }




        // Helper function to flash button red twice
        function flashButtonRed(button) {
            let flashCount = 0;
            const interval = setInterval(() => {
                button.style.backgroundColor = flashCount % 2 === 0 ? 'red' : '';  // Toggle between red and default
                flashCount += 1;

                if (flashCount === 4) {  // Stop after two flashes
                    clearInterval(interval);
                }
            }, 500);  // Flash every 500ms
        }

        // Helper function to flash button green twice
        function flashButtonGreen(button) {
            let flashCount = 0;
            const interval = setInterval(() => {
                button.style.backgroundColor = flashCount % 2 === 0 ? 'green' : '';  // Toggle between green and default
                flashCount += 1;

                if (flashCount === 4) {  // Stop after two flashes
                    clearInterval(interval);
                }
            }, 500);  // Flash every 500ms
        }


        

        document.getElementById('update-invoice-record-btn').addEventListener('click', () => {
            fetch('/auto_workflows/start_update_invoice_record', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                alert(data.message || 'Task triggered successfully!');
            })
            .catch(error => {
                console.error('Error triggering task:', error);
                alert('Failed to trigger task.');
            });
        });

        function loadInvoiceRecordSummary() {
            const week = document.getElementById('week-selector-summary').value;
            const year = document.getElementById('year-selector-summary').value;

            if (!week || !year) {
                alert("Please select both week and year!");
                return;
            }

            fetch('/auto_workflows/load_invoice_summary', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ week_number: parseInt(week), year: parseInt(year) })
            })
            .then(response => response.json())
            .then(data => {
                const tableBody = document.querySelector('#invoice-record-summary-table tbody');
                tableBody.innerHTML = '';  // Clear previous content

                if (data.error) {
                    alert("Error: " + data.error);
                    return;
                }

                data.data.forEach(record => {
                    const row = `
                        <tr>
                            <td>${record.store_name}</td>
                            <td>${record.store_number}</td>
                            <td>${record.tenant_name}</td>
                            <td>${record.status}</td>
                        </tr>`;
                    tableBody.innerHTML += row;
                });

                if (data.data.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="4" class="text-center">No records found</td></tr>`;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to load summary.');
            });
        }
        
        function loadSalesInvoiceRecordSummary() {
            const week = document.getElementById('week-selector-sales').value;
            const year = document.getElementById('year-selector-sales').value;

            if (!week || !year) {
                alert("Please select both week and year!");
                return;
            }

            fetch('/auto_workflows/load_invoice_summary_sales', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ week_number: parseInt(week), year: parseInt(year) })
            })
            .then(response => response.json())
            .then(data => {
                const tableBody = document.querySelector('#sales-invoice-record-summary-table tbody');
                tableBody.innerHTML = ''; // Clear previous content

                if (data.error) {
                    alert("Error: " + data.error);
                    return;
                }

                data.data.forEach(record => {
                    const row = `
                        <tr>
                            <td>${record.store_name}</td>
                            <td>${record.store_number}</td>
                            <td>${record.tenant_name}</td>
                            <td>${record.mileage_status}</td>
                            <td>${record.sales_status}</td>
                        </tr>`;
                    tableBody.innerHTML += row;
                });

                if (data.data.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="5" class="text-center">No records found</td></tr>`;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to load summary.');
            });
        }

        function processInventoryData() {
            document.getElementById('inventory-task-status').textContent = "Task is running...";
            document.getElementById('inventory-progress-container').style.display = "block";

            fetch('/auto_workflows/process_inventory_data')
                .then(response => response.json())
                .then(data => {
                    if (data.task_id) {
                        trackTaskProgress(data.task_id, 'inventory');
                    } else {
                        document.getElementById('inventory-task-status').textContent = "Error starting task.";
                    }
                })
                .catch(error => {
                    console.error('Error starting task:', error);
                    document.getElementById('inventory-task-status').textContent = "Error starting task.";
                });
        }


        function downloadInventoryTemplate() {
            fetch('/auto_workflows/create_inventory_template')
                .then(response => {
                    if (response.ok) {
                        return response.blob();
                    } else {
                        alert("Error creating template.");
                        throw new Error("Failed to create template.");
                    }
                })
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.style.display = "none";
                    a.href = url;
                    a.download = "Inventory_Record.xlsx";
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                })
                .catch(error => console.error("Error downloading template:", error));
        }

        // Fetch and display inventory status
        function loadInventoryStatus() {
            fetch('/auto_workflows/get_inventory_status') // Replace with your backend endpoint
                .then(response => response.json())
                .then(data => {
                    const tableBody = document.querySelector('#inventory-status-table tbody');
                    tableBody.innerHTML = ''; // Clear previous content

                    if (data.error) {
                        alert("Error: " + data.error);
                        return;
                    }

                    data.forEach(record => {
                        const dataComplete = record.data_complete ? '<span style="color: green;">✔</span>' : '<span style="color: red;">✘</span>';
                        const processed = record.processed ? '<span style="color: green;">✔</span>' : '<span style="color: red;">✘</span>';
                        const actionButton = !record.processed
                            ? `<button class="btn btn-primary btn-sm" onclick="processInventoryMonth(${record.month}, ${record.year})">Process</button>`
                            : '<span class="text-muted">Processed</span>';

                        const row = `
                            <tr>
                                <td>${record.month}</td>
                                <td>${record.year}</td>
                                <td>${dataComplete}</td>
                                <td>${processed}</td>
                                <td>${actionButton}</td>
                            </tr>`;
                        tableBody.innerHTML += row;
                    });
                })
                .catch(error => console.error('Error fetching inventory status:', error));
        }

        // Process inventory for a specific month and year
        function processInventoryMonth(month, year) {
            if (!confirm(`Are you sure you want to process inventory for ${month}/${year}?`)) {
                return;
            }

            fetch('/auto_workflows/process_inventory_month', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ month, year })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(`Inventory for ${month}/${year} processed successfully!`);
                        loadInventoryStatus(); // Refresh table
                    } else {
                        alert(`Error: ${data.error}`);
                    }
                })
                .catch(error => console.error('Error processing inventory:', error));
        }





    </script>
{% endblock %}
